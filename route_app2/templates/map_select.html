<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>道路選択</title>
    <style>
        #map { width: 100%; height: 90vh; }
    </style>
</head>
<body>
    <h3>回避したい道路をクリックしてください（複数可）</h3>

    <form action="/route" method="post">
        <h3>目的地</h3>
        緯度: <input type="text" name="end_lat" value="36.3894"><br>
        経度: <input type="text" name="end_lon" value="139.0636"><br><br>
        <input type="submit" value="経路を計算">
    </form>

    {{ m | safe }}

    <script>
        let avoid_edges = []; // 選択した道路IDを配列で保持

        setTimeout(() => {
            document.querySelectorAll(".leaflet-interactive").forEach(layer => {
                layer.addEventListener("click", function() {
                    const eid = this.getAttribute("data-edge-id");
                    if (eid && !avoid_edges.includes(eid)) {
                        avoid_edges.push(eid);       // 配列に追加
                        this.style.stroke = "red";   // 即時反映
                        console.log("回避リンク追加:", eid);
                    }
                });
            });

            // フォーム送信時に配列を hidden input に入れる
            const form = document.querySelector("form");
            form.addEventListener("submit", function(e) {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "avoid_edges";
                input.value = avoid_edges.join(","); // カンマ区切りで送信
                form.appendChild(input);
            });
        }, 800);
    </script>
</body>
</html>
